#!/bin/sh

echo "Content-type: text/plain"
echo ""

# Extract the command from the URL
command=$(echo "$QUERY_STRING" | awk -F'=' '{print $2}' | awk -F'&' '{print $1}')

# Setup the path to your custom PTZ binary
if [ -f /home/HACKSD ] || [ -f /tmp/HACKSD ]; then
    ptz_bin="/media/hack/ptz-ctrl"
else
    ptz_bin="/home/hack/ptz-ctrl"
fi

cgi_cmd() {
    /bak/httpclt get "http://127.0.0.1:8001/$1" > /dev/null 2>&1
}

case "$command" in
    "iron") 
        gio -s 23 0 > /dev/null
        echo "IR LEDs On" ;;
    "iroff") 
        gio -s 23 1 > /dev/null
        echo "IR LEDs Off" ;;
    "lighton") 
        gio -s 24 0 > /dev/null
        echo "Light On" ;;
    "lightoff") 
        gio -s 24 1 > /dev/null
        echo "Light Off" ;;
    "ircutnight") 
        cgi_cmd 'ircut?mode=night'
        # IR Cut usually needs a moment to flip before turning off LEDs
        sleep 1
        echo "Night Mode Active" ;;
    "ircutday") 
        cgi_cmd 'ircut?mode=day'
        echo "Day Mode Active" ;;
    "ptzu")  $ptz_bin u  > /dev/null && echo "Moving Up" ;;
    "ptzd")  $ptz_bin d  > /dev/null && echo "Moving Down" ;;
    "ptzl")  $ptz_bin l  > /dev/null && echo "Moving Left" ;;
    "ptzr")  $ptz_bin r  > /dev/null && echo "Moving Right" ;;
    "ptzlu") $ptz_bin lu > /dev/null && echo "Moving Left-Up" ;;
    "ptzld") $ptz_bin ld > /dev/null && echo "Moving Left-Down" ;;
    "ptzru") $ptz_bin ru > /dev/null && echo "Moving Right-Up" ;;
    "ptzrd") $ptz_bin rd > /dev/null && echo "Moving Right-Down" ;;
    "uptime") 
        uptime | awk '{print "Uptime: " $3 " " $4}' | sed 's/,//g' ;;
    *)
        echo "Unknown command: $command" ;;
esac